# Microsoft Sentinel (SIEM)

## Objectives for the next 8 Labs that will be configuring our security incident event management system.

- World Attach Maps Constructions
- Analytics, Alerting, and Incident Generation
- Attack Traffic Generation
- Run Insecure Environment for 24 hours and Capture Analytics
- Incident 1 - Brute Force Success (Windows) | Working Incidents and Incident Response
- Incident 2 - Possible Privilege Escalating | Working Incidents and Incident Response
- Incident 3 - Brute Force Success (Linux) | Working Incidents and Incident Response
- Incident 4 - Possible Malware Outbreak | Working Incidents and Incident Response

### Environments and Technologies Used:

- Microsoft Azure
- Microsoft Sentinel
- Microsoft Cloud Defender

### Operating Systems Used:

- VM Windows 10 PRO (21H2)
- VM Linux Ubuntu 20.12

#### World Attach Maps Constructions
<details close>

<div>

</summary>


**Reminder: Check your Subscription’s Cost Analysis**

### Actions and Observations<b>

- In Sentinel, we will develop four distinct workbooks showcasing diverse forms of malicious traffic originating from various global locations, all directed at our resources.

- To streamline the process and minimize errors and inquiries, we will utilize pre-built JSON maps. However, we will still provide a comprehensive explanation of the entire process during the labs.

--- 

> Within Microsoft Sentinel | Workbooks, we will introduce a new workbook with the aim of constructing our map. It's important to note that Sentinel utilizes our Log Analytics Workspace, where we have ingested the relevant logs as part of the process.

<p align="center">
<img src="https://i.imgur.com/GAHuCZw.png" height="70%" width="70%" alt="Azure Free Account"/> 
</p>

- To enhance the clarity of the workbook, we will begin by removing the pre-included reports.
- Next, we will proceed to add a query for data retrieval.
- Within the Advanced Editor, we will paste the provided [KQL .JSON](https://github.com/joshmadakor1/Cyber-Course/blob/main/Sentinel-Maps(JSON)/linux-ssh-auth-fail.json) Information to further refine the configuration.

> Once you execute your query, the graph should populate with the corresponding data, providing a visual representation of the results.

<p align="center">
<img src="https://i.imgur.com/uQxkxWK.png" height="70%" width="70%" alt="Azure Free Account"/> 
</p>

> Please keep in mind that the graphs generated by each participant will differ since they are based on the attacks received within a specific timeframe. This ensures that the visual representations will reflect the unique data and experiences of each individual.

> By utilizing the provided KQL code, we are able to observe instances of Linux VM Authentication SSH Failures.
 Edit > Settings > Map Settings  

<p align="center">
<img src="https://i.imgur.com/NFxdvI5.png" height="70%" width="70%" alt="Azure Free Account"/> 
</p>

> At this stage, you have the flexibility to further customize both the map and its associated details according to your preferences. However, for the purposes of this demonstration, I will keep the settings at their default configuration.

> Let's proceed by saving the workbook. Once saved, we can then repeat the aforementioned steps for creating the other maps.

<p align="center">
<img src="https://i.imgur.com/acp1GEx.png" height="70%" width="70%" alt="Azure Free Account"/> 
</p

> Subsequently, we shall generate a chart illustrating instances of [MS SQL Authentication Fail](https://github.com/joshmadakor1/Cyber-Course/blob/main/Sentinel-Maps(JSON)/mssql-auth-fail.json)

<p align="center">
<img src="https://i.imgur.com/qwD55SO.png" height="70%" width="70%" alt="Azure Free Account"/> 
</p

> Let's proceed by reiterating the process for the following maps, utilizing the KQL code entry.

- [NSG Malicious Allowed In](https://github.com/joshmadakor1/Cyber-Course/blob/main/Sentinel-Maps(JSON)/nsg-malicious-allowed-in.json)

<p align="center">
<img src="https://i.imgur.com/BUhROQX.png" height="70%" width="70%" alt="Azure Free Account"/> 
</p

- [Windows RDP & SMB Authentication Failures](https://github.com/joshmadakor1/Cyber-Course/blob/main/Sentinel-Maps(JSON)/windows-rdp-auth-fail.json)

<p align="center">
<img src="https://i.imgur.com/uYY6Lgb.png" height="70%" width="70%" alt="Azure Free Account"/> 
</p

> We have the flexibility to modify and adjust the timeframe to examine the specific locations and nature of attacks that occurred within a particular time period. As an illustration, I will set the timeframe to 30 minutes:

<p align="center">
<img src="https://i.imgur.com/TeH4n5i.png" height="70%" width="70%" alt="Azure Free Account"/> 
</p

> You should possess four tailor-made workbooks appearing as such:

<p align="center">
<img src="https://i.imgur.com/nWqabDs.png" height="70%" width="70%" alt="Azure Free Account"/> 
</p

> During future labs, we will have the opportunity to generate our own attacks and incorporate them into these maps. For instance, if we create a virtual machine in Asia and proceed to attack the home base VM, a data point will be appended to the graphs based on the method of attack employed. 
<div>

### Troubleshooting: 

> If it has been 24 hours since the creation of the tracked resources on this map, and you are not observing any traffic to them, it is essential to verify the following:

1. Confirm if any logs appear by generating traffic manually.
2. Ensure that both virtual machines (VMs) are powered on.
3. Verify that Microsoft Defender for Cloud and the Data Collection Rules are accurately configured to collect logs from the VMs. Refer to the "Logging and Monitoring: Enable MDC and Configure Log Collection for Virtual Machines" section for guidance.
4. Ensure that logging is appropriately configured for MS SQL Server as described in the "Azure Intro: Creating our Subscription and First Resources" section.
5. If the NSG (Network Security Group) Flow Logs are empty, double-check their configuration based on the instructions provided in the "Logging and Monitoring: Enable MDC and Configure Log Collection for Virtual Machines" section.
6. Alternatively, you can proceed to the "Azure Sentinel: Attack Traffic Generation" section to generate some traffic. However, it is crucial to confirm that logging is correctly configured and visible before attempting this step.

<div> 

<details close>

---

</summary>

### Analytics, Alerting, and Incident Generation

- This lab will focus on Analytics, Alerting, and Incident Generation. Our primary focus will be on these areas throughout the lab.

- We will manually proceed to add the rules and subsequently trigger the alerts. Our objective is to thoroughly analyze and comprehend the alerts by dissecting them, gaining a deep understanding of the underlying events and actions taking place. 

![image](https://user-images.githubusercontent.com/109401839/235291419-36c75299-c9a9-4b64-a51c-f4b10ce43164.png)

> We will commence with a Windows machine performing a brute force attempt as our initial scenario.

``` 
SecurityEvent
| where EventID == 4625
| where TimeGenerated > ago(60m)
| summarize FailureCount = count() by SourceIP = IpAddress, EventID, Activity
| where FailureCount >= 10
```

> Let's input the following query into our Log Analytics workspace and execute it. The query will display the EventID 4625 occurrences within the specified timeframe, which in this case is 60 minutes. Following that, we will examine the categories and observe the failure count. This count will help us determine whether there were multiple instances of the same attack, or if there were 10 separate instances involving the same IP, EventID, and activity attempting the attack. The failure count provides this valuable insight.

> While we don't want to trigger an alert every time a user makes a few mistakes, if a certain user fails more than ten times, it becomes quite suspicious. In such cases, we can generate an alert to flag this activity as potentially malicious or suspicious.

<p align="center">
<img src="https://i.imgur.com/I883WLN.png" height="70%" width="70%" alt="Azure Free Account"/> 
</p

> Now we will proceed to add a query rule that mirrors the previous KQL query. 

<p align="center">
<img src="https://i.imgur.com/Sdmlb0o.png" height="70%" width="70%" alt="Azure Free Account"/> 
</p

- Regarding tactics and techniques, we will specifically choose "Credential Access" and "Brute Force" as our selections.
- Within the "Set rule logic" section, we will paste the query for the brute force attempt and carefully examine the query results. 

<p align="center">
<img src="https://i.imgur.com/ZxrEGLb.png" height="70%" width="70%" alt="Azure Free Account"/> 
</p

In the "Alert enrichment" section, specifically under "Entity Mapping," we will configure the following:

1. Set up IP Entity:
- Entity Type: Address
- Field Name: AttackerIP

2. Add a new entity:
- Set up Host:
  - Entity Type: Hostname
  - Field Name: DestinationHostName
By implementing these configurations, we can enhance the alert information with relevant entities such as IP addresses and hostnames. 

<p align="center">
<img src="https://i.imgur.com/lg2RUlr.png" height="70%" width="70%" alt="Azure Free Account"/> 
</p

> Suppose an attacker with the IP address  launches an attack on our network. In such a scenario, we will receive an initial alert. However, Azure Sentinel will track and correlate subsequent actions associated with that IP address, mapping them to additional alerts. This capability allows for a comprehensive view of the attacker's activities and helps identify any related threats or malicious actions. 

 <p align="center">
<img src="https://i.imgur.com/J65Xk3u.png" height="70%" width="70%" alt="Azure Free Account"/> 
</p>
<p align="center">
<img src="https://i.imgur.com/PC3RDMc.png" height="70%" width="70%" alt="Azure Free Account"/> 
</p>
	
> Our rule is now prepared for action, validated, and ready to be created. Once created, we should be able to observe any incidents it generates. It's worth noting that almost immediately after the rule's creation, an incident was generated, highlighting its effectiveness and swift response. 

 <p align="center">
<img src="https://i.imgur.com/Qod6yDw.png" height="70%" width="70%" alt="Azure Free Account"/> 
</p>
<p align="center">
<img src="https://i.imgur.com/kZ0rP3d.png" height="70%" width="70%" alt="Azure Free Account"/> 
</p>

> Located at the bottom left, we can click on "Investigate" to access a visually appealing infographic that provides a comprehensive overview of the attack on the host. This infographic offers a clear and concise representation of the attack, aiding in our understanding and analysis of the incident.

<p align="center">
<img src="https://i.imgur.com/lStgMAF.png" height="70%" width="70%" alt="Azure Free Account"/> 
</p

- Now, let's proceed to delete the test incident alert and the test alert. We will then import a set of authentic queries to work with, enabling us to analyze real-world scenarios and enhance our understanding of the system.  

> If you encountered any issues during this step and the query did not yield any incidents, you have an alternative option. You can remote into your VM intentionally and deliberately fail the login attempt ten times. By doing so, you will generate the desired incident and proceed with the subsequent steps of the lab successfully.

- To simplify the process, you can now download the query rule list, which will facilitate your workflow and make your tasks more efficient.

---

[Sentinel Analytics Rules](https://github.com/joshmadakor1/Cyber-Course/blob/main/Sentinel-Analytics-Rules/Sentinel-Analytics-Rules(KQL%20Alert%20Queries).json)

---

> Upon importing the rules, we have already witnessed the generation of three incidents. This serves as a testament to the effectiveness and productivity of our work.

<p align="center">
<img src="https://i.imgur.com/EJvKXa4.png" height="70%" width="70%" alt="Azure Free Account"/> 
</p

- The following are the imported active rules:

<p align="center">
<img src="https://i.imgur.com/6n3msm8.png" height="70%" width="70%" alt="Azure Free Account"/> 
</p

> Feel free to explore and familiarize yourself with each component. For instance, let's take a look at "CUSTOM: Possible Privilege Escalation (Global Admin Role Assignment)" rule. Under the "Set Rule Logic" section, we can examine the rule query and break it down into its components for better understanding.

```
AuditLogs
| where OperationName == "Add member to role" and Result == "success"
| where TargetResources[0].modifiedProperties[1].newValue == '"Company Administrator"' and TargetResources[0].type == "User"
| project TimeGenerated, OperationName, AssignedRole = TargetResources[0].modifiedProperties[1].newValue, InitiatorId = InitiatedBy.user.id, InitiatorUpn = InitiatedBy.user.userPrincipalName, TargetAccountId = TargetResources[0].id, TargetAccountUpn = TargetResources[0].userPrincipalName, InitiatorIpAddress = InitiatedBy.user.ipAddress, Status = Result
```
---

- Here is a breakdown of each line:

> "AuditLogs" represents the name of the table being queried, which typically stores logs pertaining to various actions performed within a Microsoft Azure environment.

``` | where OperationName == "Add a member to role" and Result == "success": ```

> This particular line in the query is designed to refine the results by filtering for entries where the operation name is "Add a member to the role" and the result is recorded as "success". This criterion helps narrow down the outcomes to exclusively display instances where users were successfully added to a role.

``` | where TargetResources[0].modifiedProperties[1].newValue == '"Company Administrator"' and TargetResources[0].type == "User": ``` 

> This line of the query serves as an additional filter to exclusively display entries where the modified property, located at index 1 of the first TargetResource (a resource involved in the operation), matches the string "Company Administrator". Furthermore, it ensures that the type of the first TargetResource is specifically identified as "User". This filtering condition is most likely employed to present successful attempts of adding a user to the "Company Administrator" role exclusively.

``` | project TimeGenerated, OperationName, AssignedRole = TargetResources[0].modifiedProperties[1].newValue, InitiatorId = InitiatedBy.user.id, InitiatorUpn = InitiatedBy.user.userPrincipalName, TargetAccountId = TargetResources[0].id, TargetAccountUpn = TargetResources[0].userPrincipalName, InitiatorIpAddress = InitiatedBy.user.ipAddress, Status = Result: ``` 

> This line in the query performs a projection operation by selecting specific columns from the filtered results. Additionally, it assigns them new names for improved readability and clarity. 

> The selected columns in this query encompass various crucial attributes. These include the timestamp of log generation (TimeGenerated), the name of the operation (OperationName), the assigned role (AssignedRole), which corresponds to the modified property at index 1 of the first TargetResource, the ID of the user who initiated the operation (InitiatorId), the user principal name of the initiating user (InitiatorUpn), the ID of the target account (TargetAccountId) corresponding to the first TargetResource, the user principal name of the target account (TargetAccountUpn) linked to the first TargetResource, the IP address of the initiating user (InitiatorIpAddress), and the operation status (Status), which signifies the outcome of the operation. These columns have been meticulously selected and renamed for enhanced readability and comprehension.

- Let's now explore the events that unfolded while you were reading my responses and I was typing them out.

<p align="center">
<img src="https://i.imgur.com/KFrBEEP.png" height="70%" width="70%" alt="Azure Free Account"/> 
</p

> Another brute force attempt was made on our Windows machine.
 

- Let's delve into the investigation and examine the details of this incident.

<p align="center">
<img src="https://i.imgur.com/gnY29zX.png" height="70%" width="70%" alt="Azure Free Account"/> 
</p

> Considering the recent occurrence of these attacks, it would be appropriate to revise the workbooks to ensure they accurately reflect the geolocation map within the timeframe of the attacks. This will provide us with a more up-to-date and comprehensive understanding of the attack patterns and their geographical origins.

![vivaldi_sbJlTVzF7M](https://user-images.githubusercontent.com/109401839/235295157-7cba01ca-2c81-4c49-b03d-7cab1c81fb77.png)

> In the last 30 minutes: 

![image](https://user-images.githubusercontent.com/109401839/235295217-06574230-fcb2-408e-b415-428896d83fe9.png)

> The entities within the workbooks provide us with valuable IP address information. These IP addresses offer insights into the sources of the attacks and assist in identifying the potential origins of malicious activities.

<details close>

<div>

</summary>

### Attack Traffic Generation

- In the spirit of assuming the role of an attacker, let's immerse ourselves in the lab by adopting the persona of a world-renowned black hat hacker. To simulate this scenario, we will initiate the generation of attack traffic intentionally, with the intention of triggering alerts and incident generation. This hands-on experience will allow us to gain deeper insights into the detection and response capabilities of the system.

To proceed with the lab activities, follow these steps:

1. Log into the "attack-vm" that was set up in our previous labs.
2. Open PowerShell as an administrator and install the Az module if it hasn't been installed already.
3. Optionally, download SQL Server Management Studio (SSMS) from the previous lab materials.
4. Download and install Visual Studio Code, which is a mandatory tool for this lab.
5. Run the PowerShell command "Install-Module Az" and select "Yes to All" when prompted to install the module and any dependencies.

By completing these steps, you will have the necessary tools and environment set up to generate the desired attack traffic and proceed with the lab exercises.

![mstsc_au4u5GMQEb](https://user-images.githubusercontent.com/109401839/235329774-464dbb88-f6f9-4e2c-bd1e-a058f73a8fa1.png)

- Download the ["Attack-Scripts"](https://github.com/joshmadakor1/Cyber-Course/tree/main/Attack-Scripts) PowerShell scripts and save the folder on your desktop. This will provide convenient access to the scripts during the lab activities.

<p align="center">
<img src="https://i.imgur.com/mz1FXq1.png" height="70%" width="70%" alt="Azure Free Account"/> 
</p

- Launch Visual Studio Code and navigate to the folder where you saved the "Attack-Scripts" PowerShell scripts. Open the folder in Visual Studio Code to begin working with the scripts and performing the necessary actions during the lab.

<p align="center">
<img src="https://i.imgur.com/W928lFG.png" height="70%" width="70%" alt="Azure Free Account"/> 
</p

> Note: While it is possible to perform the actions carried out by these scripts manually, it is beneficial to gain experience using scripts as they can enhance efficiency and versatility. If you find yourself uncertain about the purpose of each line in the script, feel free to copy and paste it into ChatGPT and request an explanation for each line at a specific age group. This will allow you to dissect and thoroughly understand the script, enabling further comprehension. Remember, knowledge builds over time, so take it step by step at your own pace.

> When using Visual Studio Code (VSC), you might encounter a prompt to install the PowerShell extension. Please proceed with installing the extension, as it will enhance your PowerShell scripting experience within VSC.

- Execute each of the following scripts one by one, carefully observing the outcomes reflected in the Log Analytics Workspace. Additionally, pay attention to the incident creation in Azure Sentinel. This will provide valuable insights into the effects of running these scripts and help you understand how they impact both the log analytics and incident detection components of the system.

- Proceed to run the script named "AAD-Brute-Force-Success-Simulator.ps1". This script simulates a successful brute force attack against Azure Active Directory (AAD). Alternatively, you can manually attempt to log into the Azure portal to mimic the same scenario. By executing this script or performing the login attempts, you will observe the corresponding results in the system.

Now let's analyze the different components of the script to gain a deeper understanding of its functionality. By dissecting the script, we can examine each component and comprehend how they work together to simulate a successful brute force attack.

Line 1: ```$tenantId = "xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" ```

> To locate your Tenant ID, navigate to the Azure Active Directory (AAD) Blade in the Azure Portal. You will be able to find your Tenant ID displayed in this section.

Line 2: ``` $username = "attacker@[your user name].onmicrosoft.com" ```

> Please provide a valid username that exists in your Azure Active Directory (AAD) Tenant. For example, in my case, the username would be "attacker@jnoriega232gmail.onmicrosoft.com". Use the appropriate username from your AAD Tenant when running the script.

Line 3: ``` $correct_password = "LabTest12345" ``` 

> Please enter the correct password for the specified user mentioned above. If you cannot recall the password, you can reset it by following these steps:

1. Open your web browser in incognito mode.
2. Sign in to Azure Active Directory (AAD) using the user's account.
3. Follow the password reset process provided by Azure AD to set a new password.
Once you have reset the password and obtained the new one, enter it when prompted while running the script.

Line 4: ``` $wrong_password = "___WRONG PASSWORD___" ``` 

> To simulate authentication failures, the script will deliberately use an incorrect password during the login attempts. This will trigger authentication failure events and help illustrate the impact of incorrect credentials on the system.

Line 5: ``` $max_attempts = 11  ``` 

> This parameter represents the number of consecutive login failures required before a successful login is simulated. 

> During the execution of the script, it will iterate through a loop, simulating 11 consecutive failed login attempts followed by 1 successful login attempt. This sequence will trigger an incident alert, indicating a potential security breach. 

<p align="center">
<img src="https://i.imgur.com/7p7qyZQ.png" height="70%" width="70%" alt="Azure Free Account"/> 
</p

> We can now go to our Log Analytics and view logs. 
Enter the query: 

```
// Failed AAD logon
let FailedLogons = SigninLogs
| where Status.failureReason == "Invalid username or password or Invalid on-premise username or password."
| where TimeGenerated > ago(1h)
| project TimeGenerated, Status = Status.failureReason, UserPrincipalName, UserId, UserDisplayName, AppDisplayName, AttackerIP = IPAddress, IPAddressFromResourceProvider, City = LocationDetails.city, State = LocationDetails.state, Country = LocationDetails.country, Latitude = LocationDetails.geoCoordinates.latitude, Longitude = LocationDetails.geoCoordinates.longitude
| summarize FailureCount = count() by AttackerIP, UserPrincipalName;
let SuccessfulLogons = SigninLogs
| where Status.errorCode == 0 
| where TimeGenerated > ago(1h)
| project TimeGenerated, Status = Status.errorCode, UserPrincipalName, UserId, UserDisplayName, AppDisplayName, AttackerIP = IPAddress, IPAddressFromResourceProvider, City = LocationDetails.city, State = LocationDetails.state, Country = LocationDetails.country, Latitude = LocationDetails.geoCoordinates.latitude, Longitude = LocationDetails.geoCoordinates.longitude
| summarize SuccessCount = count() by AuthenticationSuccessTime = TimeGenerated, AttackerIP, UserPrincipalName, UserId, UserDisplayName;
let BruteForceSuccesses = SuccessfulLogons
| join kind = inner FailedLogons on AttackerIP, UserPrincipalName;
BruteForceSuccesses
| project AttackerIP, TargetAccount = UserPrincipalName, UserId, FailureCount, SuccessCount, AuthenticationSuccessTime
```

> Executing this query will generate results that indicate a successful brute force attack in Azure Active Directory (AAD). Please allow some time for the results to populate, as they depend on the execution of the script. Be patient while waiting for the query results to display the outcomes of the script execution.

<p align="center">
<img src="https://i.imgur.com/HvksGSp.png" height="70%" width="70%" alt="Azure Free Account"/> 
</p

- Afterward, we will execute the script called "SQL-Brute-Force-Simulator.ps1". This script emulates a brute force attack on our MS SQL Server. As an alternative approach, we can manually attempt this by utilizing SSMS and deliberately logging in with incorrect credentials. To do so, simply make repeated failed login attempts (10 or more).

- Throughout the script's execution, it will make numerous authentication and login attempts. However, it's important to note that rapid login attempts might not always be accurately recorded. Hence, to mitigate this issue, we will cap the maximum attempts at 50. In the event of reaching this threshold, an incident alert will be triggered to notify us of a potential security breach.
	
<p align="center">
<img src="https://i.imgur.com/RZNIfTW.png" height="70%" width="70%" alt="Azure Free Account"/> 
</p	
	
> We can now access our Log Analytics platform to review the logs. Please input the following query:	
	
```
// Brute Force Attempt MS SQL Server
let IpAddress_REGEX_PATTERN = @"\b\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}\b";
Event
| where EventLog == "Application"
| where EventID == 18456
| where TimeGenerated > ago(1hr)
| project TimeGenerated, AttackerIP = extract(IpAddress_REGEX_PATTERN, 0, RenderedDescription), DestinationHostName = Computer, RenderedDescription
| summarize FailureCount = count() by AttackerIP, DestinationHostName
| where FailureCount >= 10
```	

> Running this query will produce results that signify a brute force attack on our MS SQL Server. Please be patient as it may take some time for the results to populate, as they rely on the script's execution. Kindly allow sufficient time for the query results to reveal the outcomes of the script execution.
	
<p align="center">
<img src="https://i.imgur.com/L99lx3k.png" height="70%" width="70%" alt="Azure Free Account"/> 
</p

- Following that, we will employ the Malware-Generator-EICAR.ps1 script to simulate the creation of malware on our Windows VM. This step is designed to trigger an incident alert, promptly notifying us of a potential malware attack.

> We can execute this in PowerShell ISE, resulting in the creation of a Windows Security Alert. Alternatively, you have the option to create a .txt file and merge the two sections of the script into it. Saving the file will then trigger the desired alert.

To execute the command in PowerShell ISE, follow these steps:

1. Copy the Malware-Generator-EICAR.ps1 script from our attack scripts folder.
2. Paste the script into a new script file.
3. Modify the parameter for the total number of viruses to generate. Change it to 10.
4. Save the modified script.
5. Finally, run the script to initiate the generation of 10 viruses.

> The script conveniently automates the process for us, but we also have the option to manually perform these steps individually.

<p align="center">
<img src="https://i.imgur.com/nlzsZsj.png" height="70%" width="70%" alt="Azure Free Account"/> 
</p

- To manually initiate the generation of malware, follow these steps:

1. Open a new Notepad document.
2. Copy and paste the first and second half of the script side by side into the Notepad document.
3. Save the file as "EICAR" to the desktop or any desired location.

<p align="center">
<img src="https://i.imgur.com/JDwprcz.png" height="70%" width="70%" alt="Azure Free Account"/> 
</p

- It appears that we have received an alert from Windows Security indicating the necessity to configure ransomware protection.

<p align="center">
<img src="https://i.imgur.com/BNQtVOg.png" height="70%" width="70%" alt="Azure Free Account"/> 
</p

- We should observe the generated malware in both Defender for Cloud and Sentinel. In Sentinel, the detection will only appear if Windows Security has taken action, depending on the configured settings. If the malware is quarantined, you will need to manually take action to resolve it. Following that, please allow some time (which could be quite lengthy) and wait for the incident or use a KQL query to view the details of the incident.

<p align="center">
<img src="https://i.imgur.com/zo2Tu7K.png" height="70%" width="70%" alt="Azure Free Account"/> 
</p

- Key-Vault-Secret-Reader.ps1
(this can be done manually by observing Key Vault Secrets in Azure Portal)
 
> Replace the name for each part of the script with your corresponding information. Run it and see the alert generate! Now you have an idea, I will just show you the results for the next two.  

![mstsc_X219qf3iEc](https://user-images.githubusercontent.com/109401839/235331049-2d9d46c5-47fa-4c5d-b88e-8723a75573db.png)

![mstsc_GVrwLTrcuz](https://user-images.githubusercontent.com/109401839/235331078-43392219-7009-49dc-8051-e1754fe3b8c4.png)

> This may disconnect you in Azure. This is the Admin attempt. 
 If you are having issues, be sure in lines 6 & 7 to add 

```
Disconnect-AzAccount
Connect-AzAccount
``` 

> That solved the issue for me there. Now sign in, and remember that the attacker roles set in previous labs do not have read rights for Azure Key vault... 

> Next is to stop the VM in Azure, this may or may not sign you out, then run it again so everything can marinate perfectly in our pot. Run the.PS1 Key Vault attack again and voila. 

![mstsc_j9qsWIkbGY](https://user-images.githubusercontent.com/109401839/235331907-8028047d-c4f6-4c2f-9a76-0299cd2e1189.png)

![keyvauilt log](https://user-images.githubusercontent.com/109401839/235332071-a6d51d5f-f62a-4022-8f26-a5b408fa6b26.PNG)

> Above we can see that our attempt is successful, and we know it is us by the same IP Address of the VM. For my instance, I was the only one who got into the Key Vault, maybe an outside threat got into yours. You can check the logs and verify, however, we should have an incident alert for all these attempts I did. 
 
![vivaldi_VozPgPs7jQ](https://user-images.githubusercontent.com/109401839/235332143-d88c13a6-97d9-4461-bbed-0fd14fb19aa9.png)

> Here is the alert. 

![vivaldi_msbQ1nQ0D3](https://user-images.githubusercontent.com/109401839/235332230-ad1f9593-4753-4640-bdf7-da33b76f7978.png)  

<details close>

<div>

</summary>

### Run Insecure Environment for 24 Hours and Capture Analytics

### Dataset 

Before 24 Hours: 
<div>

| Metric                   | Count
| ------------------------ | -----
| SecurityEvent            | 39046
| Syslog                   | 782
| SecurityAlert            | 0
| SecurityIncident         | 222
| AzureNetworkAnalytics_CL | 1350

![Windows RDP   SMB Authentication Failure(Before)](https://user-images.githubusercontent.com/109401839/235335964-ef063912-f0b7-4761-a95b-911c21f240b7.png)

![Linux SSH Auth Failure (Before)](https://user-images.githubusercontent.com/109401839/235335965-63e57ce1-2d54-4256-a86c-4e7962eda71e.png)

![MySQL Authentication Failures(Before)](https://user-images.githubusercontent.com/109401839/235335966-25b63a64-750c-4275-9f54-a5ec72bd0a7c.png)

![nsg-malicious-allowed-in (before)](https://user-images.githubusercontent.com/109401839/235335967-faab4541-ea6c-4276-8b17-1b446613ff9f.png)

HELPER QUERIES	
		
	Helper KQL Queries
		
Start Time	

``` 
"range x from 1 to 1 step 1
| project StartTime = ago(24h), StopTime = now()"
 ``` 
	
![vivaldi_TqMaMGLc0s](https://user-images.githubusercontent.com/109401839/235334642-729e7798-48b3-43ea-870b-85ed6425f3c1.png)
	
Stop Time			
Security Events (Windows VMs)	"SecurityEvent
| where TimeGenerated >= ago(24h)
| count"

		
Syslog (Linux VMs)	"Syslog
| where TimeGenerated >= ago(24h)
| count"	

	
SecurityAlert (Microsoft Defender for Cloud)	"SecurityAlert
| where DisplayName !startswith ""CUSTOM"" and DisplayName !startswith ""TEST""
| where TimeGenerated >= ago(24h)
| count"
		
Security Incident (Sentinel Incidents)	"SecurityIncident
| where TimeGenerated >= ago(24h)
| count"	

	
NSG Inbound Malicious Flows Allowed	"AzureNetworkAnalytics_CL 
| where FlowType_s == ""MaliciousFlow"" and AllowedInFlows_d > 0
| where TimeGenerated >= ago(24h)
| count"

	
NSG Inbound Malicious Flows Blocked	"AzureNetworkAnalytics_CL 
| where FlowType_s == ""MaliciousFlow"" and DeniedInFlows_d > 0
| where TimeGenerated >= ago(24h)
| count"		

![image](https://user-images.githubusercontent.com/109401839/235336299-df51515e-aea1-424d-a880-572722e5627b.png)

### Incident Response & System Hardening

<div>

</summary>

| Check your Subscription’s Cost Analysis

As you work an incident, I would recommend taking notes between each step.

 - Work the incidents being generated within Azure Sentinel, in accordance with the NIST 800-61 Incident Management Lifecycle. Make use of the provided Pl.

- Step 1: Preparation
(We initiated this already by ingesting all of the logs into Log Analytics Workspace and Sentinel and configuring alert rules)

- Step 2: Detection & Analysis (You may have different alerts/incidents)
Set Severity, Status, Owner
View Full Details (New Experience)
Observe the Activity Log (for history of incident)
Observe Entities and Incident Timelines (are they doing anything else?)
“Investigate” the incident and continue trying to determine the scope
Inspect the entities and see if there are any related events
Determine legitimacy of the incident (True Positive, False Positive, etc.)
If True Positive, continue, if False positive, close it out.

- Step 3: Containment, Eradication, and Recovery
Use the simple Incident Response PlayBook

- Step 4: Document Findings/Info and Close out the Incident in Sentinel

Incident 1 - Brute Force Success (Windows) - Working Incidents and Incident Response
<details close>

<div>

</summary>

- Set Severity, Status, Owner

![vivaldi_cuZM38TCe3](https://user-images.githubusercontent.com/109401839/235336573-c38e5325-e4df-4aad-93f8-b04487099a32.png)

- View Full Details (New Experience)

![c5qFJgKgq8](https://user-images.githubusercontent.com/109401839/235336592-2ec5579f-aa33-42f3-9e80-ce549f1b5da6.png)

- Observe the Activity Log (for history of incident)

![vivaldi_8f1Oj6rUd5](https://user-images.githubusercontent.com/109401839/235336637-50bf9a05-b3a5-4266-b009-866991f902de.png)

- Observe Entities and Incident Timelines

![vivaldi_OEaYg3xMGs](https://user-images.githubusercontent.com/109401839/235336701-eca2ef8d-4302-45df-952d-c92d167f082c.png)

If we click this IP Address, we can see their Geo Data. 

![vivaldi_iL5aNXLtVZ](https://user-images.githubusercontent.com/109401839/235336728-c55a52dc-df04-43ac-ab5f-e22bf65265d8.png)

- Investigate & Determine The Scope

![vivaldi_KhX7Mked3T](https://user-images.githubusercontent.com/109401839/235336764-4da5f6ad-5274-4c32-978d-ca5697cb52b2.png)

If we see related alerts based on this attacker we can see what else they have done in correlation to their IP Address. They are related to 41 other events. 

This attacker is related to +26 attempted Brute Force Attacks and over 14 successful Brute Force Attacks. 

![vivaldi_R4miIRFQH2](https://user-images.githubusercontent.com/109401839/235336831-6618b357-320c-4702-918a-7c9f4bbe5ad0.png)

![vivaldi_jzhkTzBq9b](https://user-images.githubusercontent.com/109401839/235336876-f16e6504-adf3-4360-8689-7babb4df3b5e.png)

We can see mroe data if view "All Aggregated Nodes" in KQL

![vivaldi_V7drXD6QZu](https://user-images.githubusercontent.com/109401839/235336905-1323b6df-4223-4b45-a59b-755220a9de9e.png)

We can see this information in KQL. 

```
let GetIPRelatedAlerts = (v_IP_Address: string) {
    SecurityAlert
    | summarize arg_max(TimeGenerated, *) by SystemAlertId
    | extend entities = todynamic(Entities)
    | mv-expand entities
    | project-rename entity=entities
    | where entity['Type'] == 'ip' and entity['Address'] =~ v_IP_Address
    | project-away entity
};
GetIPRelatedAlerts(@'110.167.169.106')
```

- Now Determine the legitimacy of the incident, True Postive or False Positive, etc. 

```

// Brute Force Success Windows
let FailedLogons = SecurityEvent
| where EventID == 4625 and LogonType == 3
| where TimeGenerated > ago(60m)
| summarize FailureCount = count() by AttackerIP = IpAddress, EventID, Activity, LogonType, DestinationHostName = Computer
| where FailureCount >= 5;
let SuccessfulLogons = SecurityEvent
| where EventID == 4624 and LogonType == 3
| where TimeGenerated > ago(60m)
| summarize SuccessfulCount = count() by AttackerIP = IpAddress, LogonType, DestinationHostName = Computer, AuthenticationSuccessTime = TimeGenerated;
SuccessfulLogons
| join kind = leftouter FailedLogons on DestinationHostName, AttackerIP, LogonType
| project AuthenticationSuccessTime, AttackerIP, DestinationHostName, FailureCount, SuccessfulCount

```
Via [Cheat Sheet](https://github.com/fnabeel/Cloud-SOC-Project-Directory/blob/main/KQL-Query-Cheat-Sheet%20(1).md) 

> We will add a clause to see entities that have had successful log ons in the last 24 hours. 

```
SecurityEvent
| where EventID == 4625
| distinct Account
``` 
![vivaldi_dnJSoEyZme](https://user-images.githubusercontent.com/109401839/235337183-cde0f5f1-eec4-4631-b597-6970c06b9a25.png)

We can further specify by using the IP Address of the attacker. 

```
| where ipaddress == "110.167.169.106"
```

and remove: 

``` | distinct Account ```

![vivaldi_JRZZok9EsC](https://user-images.githubusercontent.com/109401839/235337271-a832ca24-7dbd-443c-a2f6-70df71664de2.png)

Based on the results, I willl conclude this to be a False Positive. 

You maybe wondering why? 
It is because even after these "successful" attempts, we can see they kept trying to bruteforce in. In addition, if we filter the activity, there is not any actual successful login attempts. We inspected the action from this IP Address, and the main issue is the persistence of this Threat Actor. With enough time, they could breach into the system.

-   If true positive, continue. If false-positive, close. 

Since it is a false positive, but the network security is bad. We will close this out but continue this by hardening our systems so this sort of incident is reduced greatly. 

Next:  Containment, Eradication, and Recovery.

Let us refer to the Incident Response Playbook. 

" 
### Incident Description
<div>
This incident involves observation of potential brute force attempts against a Windows VM.

### Initial Response Actions
<div>

- Verify the authenticity of the alert or report

- Immediately isolate the machine and change the password of the affected user.

- Identify the origin of the attacks and determine if they are attacking or involved with anything else.

- Determine how and when the attack occurred
Are the NSGs not being locked down? If so, check other NSGs

- Assess the potential impact of the incident.

- What type of account was it? Permissions?

### Containment and Recovery
<div>

- Lock down the NSG assigned to that VM/Subnet, either entirely, or to allow only necessary traffic

- Reset the affected user’s password

- Enable MFA

### Document Findings and Close out Incident
"

 ![hardening ip](https://user-images.githubusercontent.com/109401839/235338083-2806e873-8855-464d-8ec0-fb7706bd1508.PNG)

So we will make the only IP address that can access this VM is our own + /32 <- which means only the specified IP Address.

![vivaldi_CoLvEd6nF3](https://user-images.githubusercontent.com/109401839/235338143-bf9b40b1-79ee-460a-94a7-bc177e2d48d2.png)

We can delete this RDP rule from earlier labs. 

So now there is not a chance they can brute force.

We will do this for all out VM. 


### Incident 2 - Possible Privilege Escalation - Working Incidents and Incident Response
<details close>

<div>

</summary>

We will do the samething again. 

![possible esdc](https://user-images.githubusercontent.com/109401839/235338529-973af8de-1de3-4dec-b6db-ca0c81d30ce0.PNG)

This has 525 Events and 25 alerts.

This was from our Powershell script I left running. We know it is a false positive since it came from my virtual machine by the matching IP address. However, if this is a real incident. We have to investigate something that is generating so many alerts. 

![vivaldi_H4U6CQUlEx](https://user-images.githubusercontent.com/109401839/235338626-7d6c3450-24c8-4821-90e3-5b2e2dbefc27.png)

Since this is within the organisation, I would just call the user and confirm the details with them. Lets pretend the user was just doing normal duties is a pentester, and corobrated with their manager to conduct this. Then we can just close it. False Positive - Inaccurate Data. 

![vivaldi_FTRBwqoRdM](https://user-images.githubusercontent.com/109401839/235338746-d2c7a33f-d1ac-4cd0-ac3d-6b032e2445cc.png)

So far I closed 3 Incidents, 1 Brute Force, 1 Permission Escalating , 1 Duplicate of the Brute force. 

![vivaldi_MjJTET0DBT](https://user-images.githubusercontent.com/109401839/235338870-1c478632-83f8-4777-b593-cb21196276b6.png)

### Incident 3 - Brute Force Success (Linux) - Microsoft Sentinel Working Incidents and Incident Response
<details close>

<div>

</summary>

In my lab, I did not have any successful Linux brute force, but we do have attempts. 

![vivaldi_mEYswyeMRa](https://user-images.githubusercontent.com/109401839/235338903-0c6a9c81-82ea-4838-96d3-f6dfb699aa1f.png)

![vivaldi_aRwcdARuEr](https://user-images.githubusercontent.com/109401839/235338914-a1daed59-f86f-4106-882e-fd8d22626e16.png)

![vivaldi_eKo6RDjcN3](https://user-images.githubusercontent.com/109401839/235338939-aabf588d-120c-410e-b21d-eba1e47ad97b.png)

We can use this KQL query to confirm if they actually Brute Force in or not to do our due diligence. 

![vivaldi_oWXidzLFP1](https://user-images.githubusercontent.com/109401839/235338986-b81f3604-1aaf-4534-aaf6-357e6b638bb8.png)

We did not, we can close this as a Benign- True Positive because there was an attempt, no successful brute forces. We can specify further by grabbing each IP Address and customising the query. First lets get more info. 

This would be good for example, 10,000 IP Addresses in an organisation was attempting to brute force and we wanted to narrow it down to just 1 IP. 

We can reset the passwords. 

![vivaldi_tQnuejPL1A](https://user-images.githubusercontent.com/109401839/235339178-8710f60a-838c-4773-b271-49038fb9bae3.png)

- Refering to the playbook, lets see if they are related to any other event. 

> They are, we remediated this by reseting password of compromsied user viritual machine and locked down NSG. 

Now we can close it as a Benign- True Positive. Closed.

- Impact of Incident

> Account was a non admin account on a linux virtual machine, possibly low impact, however attacker is invovled in many other incidents. These wil be remediated by NSG hardening. 

### Incident 4 - Possible Malware Outbreak - Working Incidents and Incident Response
<details close>

<div>

</summary>

![vivaldi_cmkHl8ibDk](https://user-images.githubusercontent.com/109401839/235339661-ed54b589-0d13-440e-9f8d-d1901c8076dd.png)

![vivaldi_iK4n16GqXA](https://user-images.githubusercontent.com/109401839/235339714-28549a49-b758-40a7-badf-cb90fcd73602.png)

![vivaldi_2ggFSrbzOX](https://user-images.githubusercontent.com/109401839/235339755-a413874f-da99-4781-a076-3cc49bb7a7d8.png)

Here do not know if the extended alerts are actually related to the incident. In thsi case malware, but it can be as typically with a breach, threat actors drop malware in as well. 

> Note: Several other alerts raised. 

We can examine the query that generated this alert. 

![vivaldi_ulG9cGZsXz](https://user-images.githubusercontent.com/109401839/235339859-2eb3d7c1-55a5-4a16-b396-1f1a0d405e3e.png)

This can be filtered by comprised entity category in KQL. 

![vivaldi_7ytY4TuYHb](https://user-images.githubusercontent.com/109401839/235339840-376912f2-8e7f-4cf3-a4ee-8bd6ba4fb9a7.png)

We can add another query to see if there is no action necessary and if the malware was remediated. 

![vivaldi_7aC88zFKiR](https://user-images.githubusercontent.com/109401839/235339918-c3fdaba0-4dc6-427a-a342-dd469a384561.png)

Which looks like it was automatically remidiated. 

We can do our due diligence and make sure by viewing the the file path. 

![vivaldi_8tIZy1xL5Q](https://user-images.githubusercontent.com/109401839/235339965-2fd9de11-2b8e-4011-8a8b-47ccd9708971.png)

It is benign true positive. 

![vivaldi_EPWAjpIU5D](https://user-images.githubusercontent.com/109401839/235340033-f65d3618-a31a-4d8f-810a-3bf5f076cffc.png)

That is it for the SIEM labs, I will mass close the tickets as Benign Positive - Suspicious but expected. 

![vivaldi_pL3PCdQkUO](https://user-images.githubusercontent.com/109401839/235340122-ae0340b3-58bb-482b-9871-0afb6e7cc5af.png)

Next part, we will harden the environment after 24 hours and document it. 

Now lets wait 24 hours. 

![vivaldi_Vbe3M5A01o](https://user-images.githubusercontent.com/109401839/235340150-0b193cd6-dbb7-4c01-b256-e5fc26c0e267.png)
