# Microsoft Sentinel (SIEM)

## Objectives for the next 8 Labs that will be configuring our security incident event management system.

- World Attach Maps Constructions
- Analytics, Alerting, and Incident Generation
- Attack Traffic Generation
- Run Insecure Environment for 24 hours and Capture Analytics
- Incident 1 - Brute Force Success (Windows) | Working Incidents and Incident Response
- Incident 2 - Possible Privilege Escalating | Working Incidents and Incident Response
- Incident 3 - Brute Force Success (Linux) | Working Incidents and Incident Response
- Incident 4 - Possible Malware Outbreak | Working Incidents and Incident Response

### Environments and Technologies Used:

- Microsoft Azure
- Microsoft Sentinel
- Microsoft Cloud Defender

### Operating Systems Used:

- VM Windows 10 PRO (21H2)
- VM Linux Ubuntu 20.12

#### World Attach Maps Constructions
<details close>

<div>

</summary>


**Reminder: Check your Subscription’s Cost Analysis**

### Actions and Observations<b>

- In Sentinel, we will develop four distinct workbooks showcasing diverse forms of malicious traffic originating from various global locations, all directed at our resources.

- To streamline the process and minimize errors and inquiries, we will utilize pre-built JSON maps. However, we will still provide a comprehensive explanation of the entire process during the labs.

--- 

> Within Microsoft Sentinel | Workbooks, we will introduce a new workbook with the aim of constructing our map. It's important to note that Sentinel utilizes our Log Analytics Workspace, where we have ingested the relevant logs as part of the process.

<p align="center">
<img src="https://i.imgur.com/GAHuCZw.png" height="70%" width="70%" alt="Azure Free Account"/> 
</p>

- To enhance the clarity of the workbook, we will begin by removing the pre-included reports.
- Next, we will proceed to add a query for data retrieval.
- Within the Advanced Editor, we will paste the provided [KQL .JSON](https://github.com/joshmadakor1/Cyber-Course/blob/main/Sentinel-Maps(JSON)/linux-ssh-auth-fail.json) Information to further refine the configuration.

> Once you execute your query, the graph should populate with the corresponding data, providing a visual representation of the results.

<p align="center">
<img src="https://i.imgur.com/uQxkxWK.png" height="70%" width="70%" alt="Azure Free Account"/> 
</p>

> Please keep in mind that the graphs generated by each participant will differ since they are based on the attacks received within a specific timeframe. This ensures that the visual representations will reflect the unique data and experiences of each individual.

> By utilizing the provided KQL code, we are able to observe instances of Linux VM Authentication SSH Failures.
 Edit > Settings > Map Settings  

<p align="center">
<img src="https://i.imgur.com/NFxdvI5.png" height="70%" width="70%" alt="Azure Free Account"/> 
</p>

> At this stage, you have the flexibility to further customize both the map and its associated details according to your preferences. However, for the purposes of this demonstration, I will keep the settings at their default configuration.

> Let's proceed by saving the workbook. Once saved, we can then repeat the aforementioned steps for creating the other maps.

<p align="center">
<img src="https://i.imgur.com/acp1GEx.png" height="70%" width="70%" alt="Azure Free Account"/> 
</p

> Subsequently, we shall generate a chart illustrating instances of [MS SQL Authentication Fail](https://github.com/joshmadakor1/Cyber-Course/blob/main/Sentinel-Maps(JSON)/mssql-auth-fail.json)

<p align="center">
<img src="https://i.imgur.com/qwD55SO.png" height="70%" width="70%" alt="Azure Free Account"/> 
</p

> Let's proceed by reiterating the process for the following maps, utilizing the KQL code entry.

- [NSG Malicious Allowed In](https://github.com/joshmadakor1/Cyber-Course/blob/main/Sentinel-Maps(JSON)/nsg-malicious-allowed-in.json)

<p align="center">
<img src="https://i.imgur.com/BUhROQX.png" height="70%" width="70%" alt="Azure Free Account"/> 
</p

- [Windows RDP & SMB Authentication Failures](https://github.com/joshmadakor1/Cyber-Course/blob/main/Sentinel-Maps(JSON)/windows-rdp-auth-fail.json)

<p align="center">
<img src="https://i.imgur.com/uYY6Lgb.png" height="70%" width="70%" alt="Azure Free Account"/> 
</p

> We have the flexibility to modify and adjust the timeframe to examine the specific locations and nature of attacks that occurred within a particular time period. As an illustration, I will set the timeframe to 30 minutes:

<p align="center">
<img src="https://i.imgur.com/TeH4n5i.png" height="70%" width="70%" alt="Azure Free Account"/> 
</p

> You should possess four tailor-made workbooks appearing as such:

<p align="center">
<img src="https://i.imgur.com/nWqabDs.png" height="70%" width="70%" alt="Azure Free Account"/> 
</p

> During future labs, we will have the opportunity to generate our own attacks and incorporate them into these maps. For instance, if we create a virtual machine in Asia and proceed to attack the home base VM, a data point will be appended to the graphs based on the method of attack employed. 
<div>

### Troubleshooting: 

> If it has been 24 hours since the creation of the tracked resources on this map, and you are not observing any traffic to them, it is essential to verify the following:

1. Confirm if any logs appear by generating traffic manually.
2. Ensure that both virtual machines (VMs) are powered on.
3. Verify that Microsoft Defender for Cloud and the Data Collection Rules are accurately configured to collect logs from the VMs. Refer to the "Logging and Monitoring: Enable MDC and Configure Log Collection for Virtual Machines" section for guidance.
4. Ensure that logging is appropriately configured for MS SQL Server as described in the "Azure Intro: Creating our Subscription and First Resources" section.
5. If the NSG (Network Security Group) Flow Logs are empty, double-check their configuration based on the instructions provided in the "Logging and Monitoring: Enable MDC and Configure Log Collection for Virtual Machines" section.
6. Alternatively, you can proceed to the "Azure Sentinel: Attack Traffic Generation" section to generate some traffic. However, it is crucial to confirm that logging is correctly configured and visible before attempting this step.

<div> 

<details close>

---

</summary>

### Analytics, Alerting, and Incident Generation

- This lab will focus on Analytics, Alerting, and Incident Generation. Our primary focus will be on these areas throughout the lab.

- We will manually proceed to add the rules and subsequently trigger the alerts. Our objective is to thoroughly analyze and comprehend the alerts by dissecting them, gaining a deep understanding of the underlying events and actions taking place. 

![image](https://user-images.githubusercontent.com/109401839/235291419-36c75299-c9a9-4b64-a51c-f4b10ce43164.png)

> We will commence with a Windows machine performing a brute force attempt as our initial scenario.

``` 
SecurityEvent
| where EventID == 4625
| where TimeGenerated > ago(60m)
| summarize FailureCount = count() by SourceIP = IpAddress, EventID, Activity
| where FailureCount >= 10
```

> Let's input the following query into our Log Analytics workspace and execute it. The query will display the EventID 4625 occurrences within the specified timeframe, which in this case is 60 minutes. Following that, we will examine the categories and observe the failure count. This count will help us determine whether there were multiple instances of the same attack, or if there were 10 separate instances involving the same IP, EventID, and activity attempting the attack. The failure count provides this valuable insight.

> While we don't want to trigger an alert every time a user makes a few mistakes, if a certain user fails more than ten times, it becomes quite suspicious. In such cases, we can generate an alert to flag this activity as potentially malicious or suspicious.

<p align="center">
<img src="https://i.imgur.com/I883WLN.png" height="70%" width="70%" alt="Azure Free Account"/> 
</p

> Now we will proceed to add a query rule that mirrors the previous KQL query. 

<p align="center">
<img src="https://i.imgur.com/Sdmlb0o.png" height="70%" width="70%" alt="Azure Free Account"/> 
</p

- Regarding tactics and techniques, we will specifically choose "Credential Access" and "Brute Force" as our selections.
- Within the "Set rule logic" section, we will paste the query for the brute force attempt and carefully examine the query results. 

<p align="center">
<img src="https://i.imgur.com/ZxrEGLb.png" height="70%" width="70%" alt="Azure Free Account"/> 
</p

In the "Alert enrichment" section, specifically under "Entity Mapping," we will configure the following:

1. Set up IP Entity:
- Entity Type: Address
- Field Name: AttackerIP

2. Add a new entity:
- Set up Host:
  - Entity Type: Hostname
  - Field Name: DestinationHostName
By implementing these configurations, we can enhance the alert information with relevant entities such as IP addresses and hostnames. 

<p align="center">
<img src="https://i.imgur.com/lg2RUlr.png" height="70%" width="70%" alt="Azure Free Account"/> 
</p

> Suppose an attacker with the IP address  launches an attack on our network. In such a scenario, we will receive an initial alert. However, Azure Sentinel will track and correlate subsequent actions associated with that IP address, mapping them to additional alerts. This capability allows for a comprehensive view of the attacker's activities and helps identify any related threats or malicious actions. 

 <p align="center">
<img src="https://i.imgur.com/J65Xk3u.png" height="70%" width="70%" alt="Azure Free Account"/> 
</p>
<p align="center">
<img src="https://i.imgur.com/PC3RDMc.png" height="70%" width="70%" alt="Azure Free Account"/> 
</p>
	
> Our rule is now prepared for action, validated, and ready to be created. Once created, we should be able to observe any incidents it generates. It's worth noting that almost immediately after the rule's creation, an incident was generated, highlighting its effectiveness and swift response. 

 <p align="center">
<img src="https://i.imgur.com/Qod6yDw.png" height="70%" width="70%" alt="Azure Free Account"/> 
</p>
<p align="center">
<img src="https://i.imgur.com/kZ0rP3d.png" height="70%" width="70%" alt="Azure Free Account"/> 
</p>

> Located at the bottom left, we can click on "Investigate" to access a visually appealing infographic that provides a comprehensive overview of the attack on the host. This infographic offers a clear and concise representation of the attack, aiding in our understanding and analysis of the incident.

<p align="center">
<img src="https://i.imgur.com/lStgMAF.png" height="70%" width="70%" alt="Azure Free Account"/> 
</p

- Now, let's proceed to delete the test incident alert and the test alert. We will then import a set of authentic queries to work with, enabling us to analyze real-world scenarios and enhance our understanding of the system.  

> If you encountered any issues during this step and the query did not yield any incidents, you have an alternative option. You can remote into your VM intentionally and deliberately fail the login attempt ten times. By doing so, you will generate the desired incident and proceed with the subsequent steps of the lab successfully.

- To simplify the process, you can now download the query rule list, which will facilitate your workflow and make your tasks more efficient.

---

[Sentinel Analytics Rules](https://github.com/joshmadakor1/Cyber-Course/blob/main/Sentinel-Analytics-Rules/Sentinel-Analytics-Rules(KQL%20Alert%20Queries).json)

---

> Upon importing the rules, we have already witnessed the generation of three incidents. This serves as a testament to the effectiveness and productivity of our work.

<p align="center">
<img src="https://i.imgur.com/EJvKXa4.png" height="70%" width="70%" alt="Azure Free Account"/> 
</p

- The following are the imported active rules:

<p align="center">
<img src="https://i.imgur.com/6n3msm8.png" height="70%" width="70%" alt="Azure Free Account"/> 
</p

> Feel free to explore and familiarize yourself with each component. For instance, let's take a look at "CUSTOM: Possible Privilege Escalation (Global Admin Role Assignment)" rule. Under the "Set Rule Logic" section, we can examine the rule query and break it down into its components for better understanding.

```
AuditLogs
| where OperationName == "Add member to role" and Result == "success"
| where TargetResources[0].modifiedProperties[1].newValue == '"Company Administrator"' and TargetResources[0].type == "User"
| project TimeGenerated, OperationName, AssignedRole = TargetResources[0].modifiedProperties[1].newValue, InitiatorId = InitiatedBy.user.id, InitiatorUpn = InitiatedBy.user.userPrincipalName, TargetAccountId = TargetResources[0].id, TargetAccountUpn = TargetResources[0].userPrincipalName, InitiatorIpAddress = InitiatedBy.user.ipAddress, Status = Result
```
---

- Here is a breakdown of each line:

> "AuditLogs" represents the name of the table being queried, which typically stores logs pertaining to various actions performed within a Microsoft Azure environment.

``` | where OperationName == "Add a member to role" and Result == "success": ```

> This particular line in the query is designed to refine the results by filtering for entries where the operation name is "Add a member to the role" and the result is recorded as "success". This criterion helps narrow down the outcomes to exclusively display instances where users were successfully added to a role.

``` | where TargetResources[0].modifiedProperties[1].newValue == '"Company Administrator"' and TargetResources[0].type == "User": ``` 

> This line of the query serves as an additional filter to exclusively display entries where the modified property, located at index 1 of the first TargetResource (a resource involved in the operation), matches the string "Company Administrator". Furthermore, it ensures that the type of the first TargetResource is specifically identified as "User". This filtering condition is most likely employed to present successful attempts of adding a user to the "Company Administrator" role exclusively.

``` | project TimeGenerated, OperationName, AssignedRole = TargetResources[0].modifiedProperties[1].newValue, InitiatorId = InitiatedBy.user.id, InitiatorUpn = InitiatedBy.user.userPrincipalName, TargetAccountId = TargetResources[0].id, TargetAccountUpn = TargetResources[0].userPrincipalName, InitiatorIpAddress = InitiatedBy.user.ipAddress, Status = Result: ``` 

> This line in the query performs a projection operation by selecting specific columns from the filtered results. Additionally, it assigns them new names for improved readability and clarity. 

> The selected columns in this query encompass various crucial attributes. These include the timestamp of log generation (TimeGenerated), the name of the operation (OperationName), the assigned role (AssignedRole), which corresponds to the modified property at index 1 of the first TargetResource, the ID of the user who initiated the operation (InitiatorId), the user principal name of the initiating user (InitiatorUpn), the ID of the target account (TargetAccountId) corresponding to the first TargetResource, the user principal name of the target account (TargetAccountUpn) linked to the first TargetResource, the IP address of the initiating user (InitiatorIpAddress), and the operation status (Status), which signifies the outcome of the operation. These columns have been meticulously selected and renamed for enhanced readability and comprehension.

- Let's now explore the events that unfolded while you were reading my responses and I was typing them out.

<p align="center">
<img src="https://i.imgur.com/KFrBEEP.png" height="70%" width="70%" alt="Azure Free Account"/> 
</p

> Another brute force attempt was made on our Windows machine.
 

- Let's delve into the investigation and examine the details of this incident.

<p align="center">
<img src="https://i.imgur.com/gnY29zX.png" height="70%" width="70%" alt="Azure Free Account"/> 
</p

> Considering the recent occurrence of these attacks, it would be appropriate to revise the workbooks to ensure they accurately reflect the geolocation map within the timeframe of the attacks. This will provide us with a more up-to-date and comprehensive understanding of the attack patterns and their geographical origins.

![vivaldi_sbJlTVzF7M](https://user-images.githubusercontent.com/109401839/235295157-7cba01ca-2c81-4c49-b03d-7cab1c81fb77.png)

> In the last 30 minutes: 

![image](https://user-images.githubusercontent.com/109401839/235295217-06574230-fcb2-408e-b415-428896d83fe9.png)

> The entities within the workbooks provide us with valuable IP address information. These IP addresses offer insights into the sources of the attacks and assist in identifying the potential origins of malicious activities.

<details close>

<div>

</summary>

### Attack Traffic Generation

- In the spirit of assuming the role of an attacker, let's immerse ourselves in the lab by adopting the persona of a world-renowned black hat hacker. To simulate this scenario, we will initiate the generation of attack traffic intentionally, with the intention of triggering alerts and incident generation. This hands-on experience will allow us to gain deeper insights into the detection and response capabilities of the system.

To proceed with the lab activities, follow these steps:

1. Log into the "attack-vm" that was set up in our previous labs.
2. Open PowerShell as an administrator and install the Az module if it hasn't been installed already.
3. Optionally, download SQL Server Management Studio (SSMS) from the previous lab materials.
4. Download and install Visual Studio Code, which is a mandatory tool for this lab.
5. Run the PowerShell command "Install-Module Az" and select "Yes to All" when prompted to install the module and any dependencies.

By completing these steps, you will have the necessary tools and environment set up to generate the desired attack traffic and proceed with the lab exercises.

![mstsc_au4u5GMQEb](https://user-images.githubusercontent.com/109401839/235329774-464dbb88-f6f9-4e2c-bd1e-a058f73a8fa1.png)

- Download the ["Attack-Scripts"](https://github.com/joshmadakor1/Cyber-Course/tree/main/Attack-Scripts) PowerShell scripts and save the folder on your desktop. This will provide convenient access to the scripts during the lab activities.

<p align="center">
<img src="https://i.imgur.com/mz1FXq1.png" height="70%" width="70%" alt="Azure Free Account"/> 
</p

- Launch Visual Studio Code and navigate to the folder where you saved the "Attack-Scripts" PowerShell scripts. Open the folder in Visual Studio Code to begin working with the scripts and performing the necessary actions during the lab.

<p align="center">
<img src="https://i.imgur.com/W928lFG.png" height="70%" width="70%" alt="Azure Free Account"/> 
</p

> Note: While it is possible to perform the actions carried out by these scripts manually, it is beneficial to gain experience using scripts as they can enhance efficiency and versatility. If you find yourself uncertain about the purpose of each line in the script, feel free to copy and paste it into ChatGPT and request an explanation for each line at a specific age group. This will allow you to dissect and thoroughly understand the script, enabling further comprehension. Remember, knowledge builds over time, so take it step by step at your own pace.

> When using Visual Studio Code (VSC), you might encounter a prompt to install the PowerShell extension. Please proceed with installing the extension, as it will enhance your PowerShell scripting experience within VSC.

- Execute each of the following scripts one by one, carefully observing the outcomes reflected in the Log Analytics Workspace. Additionally, pay attention to the incident creation in Azure Sentinel. This will provide valuable insights into the effects of running these scripts and help you understand how they impact both the log analytics and incident detection components of the system.

- Proceed to run the script named "AAD-Brute-Force-Success-Simulator.ps1". This script simulates a successful brute force attack against Azure Active Directory (AAD). Alternatively, you can manually attempt to log into the Azure portal to mimic the same scenario. By executing this script or performing the login attempts, you will observe the corresponding results in the system.

Now let's analyze the different components of the script to gain a deeper understanding of its functionality. By dissecting the script, we can examine each component and comprehend how they work together to simulate a successful brute force attack.

Line 1: ```$tenantId = "xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" ```

> To locate your Tenant ID, navigate to the Azure Active Directory (AAD) Blade in the Azure Portal. You will be able to find your Tenant ID displayed in this section.

Line 2: ``` $username = "attacker@[your user name].onmicrosoft.com" ```

> Please provide a valid username that exists in your Azure Active Directory (AAD) Tenant. For example, in my case, the username would be "attacker@jnoriega232gmail.onmicrosoft.com". Use the appropriate username from your AAD Tenant when running the script.

Line 3: ``` $correct_password = "LabTest12345" ``` 

> Please enter the correct password for the specified user mentioned above. If you cannot recall the password, you can reset it by following these steps:

1. Open your web browser in incognito mode.
2. Sign in to Azure Active Directory (AAD) using the user's account.
3. Follow the password reset process provided by Azure AD to set a new password.
Once you have reset the password and obtained the new one, enter it when prompted while running the script.

Line 4: ``` $wrong_password = "___WRONG PASSWORD___" ``` 

> To simulate authentication failures, the script will deliberately use an incorrect password during the login attempts. This will trigger authentication failure events and help illustrate the impact of incorrect credentials on the system.

Line 5: ``` $max_attempts = 11  ``` 

> This parameter represents the number of consecutive login failures required before a successful login is simulated. 

> During the execution of the script, it will iterate through a loop, simulating 11 consecutive failed login attempts followed by 1 successful login attempt. This sequence will trigger an incident alert, indicating a potential security breach. 

<p align="center">
<img src="https://i.imgur.com/7p7qyZQ.png" height="70%" width="70%" alt="Azure Free Account"/> 
</p

> We can now go to our Log Analytics and view logs. 
Enter the query: 

```
// Failed AAD logon
let FailedLogons = SigninLogs
| where Status.failureReason == "Invalid username or password or Invalid on-premise username or password."
| where TimeGenerated > ago(1h)
| project TimeGenerated, Status = Status.failureReason, UserPrincipalName, UserId, UserDisplayName, AppDisplayName, AttackerIP = IPAddress, IPAddressFromResourceProvider, City = LocationDetails.city, State = LocationDetails.state, Country = LocationDetails.country, Latitude = LocationDetails.geoCoordinates.latitude, Longitude = LocationDetails.geoCoordinates.longitude
| summarize FailureCount = count() by AttackerIP, UserPrincipalName;
let SuccessfulLogons = SigninLogs
| where Status.errorCode == 0 
| where TimeGenerated > ago(1h)
| project TimeGenerated, Status = Status.errorCode, UserPrincipalName, UserId, UserDisplayName, AppDisplayName, AttackerIP = IPAddress, IPAddressFromResourceProvider, City = LocationDetails.city, State = LocationDetails.state, Country = LocationDetails.country, Latitude = LocationDetails.geoCoordinates.latitude, Longitude = LocationDetails.geoCoordinates.longitude
| summarize SuccessCount = count() by AuthenticationSuccessTime = TimeGenerated, AttackerIP, UserPrincipalName, UserId, UserDisplayName;
let BruteForceSuccesses = SuccessfulLogons
| join kind = inner FailedLogons on AttackerIP, UserPrincipalName;
BruteForceSuccesses
| project AttackerIP, TargetAccount = UserPrincipalName, UserId, FailureCount, SuccessCount, AuthenticationSuccessTime
```

> Executing this query will generate results that indicate a successful brute force attack in Azure Active Directory (AAD). Please allow some time for the results to populate, as they depend on the execution of the script. Be patient while waiting for the query results to display the outcomes of the script execution.

<p align="center">
<img src="https://i.imgur.com/HvksGSp.png" height="70%" width="70%" alt="Azure Free Account"/> 
</p

-Afterward, we will execute the script called "SQL-Brute-Force-Simulator.ps1". This script emulates a brute force attack on our MS SQL Server. As an alternative approach, we can manually attempt this by utilizing SSMS and deliberately logging in with incorrect credentials. To do so, simply make repeated failed login attempts (10 or more).

-Throughout the script's execution, it will make numerous authentication and login attempts. However, it's important to note that rapid login attempts might not always be accurately recorded. Hence, to mitigate this issue, we will cap the maximum attempts at 50. In the event of reaching this threshold, an incident alert will be triggered to notify us of a potential security breach.
	
<p align="center">
<img src="https://i.imgur.com/RZNIfTW.png" height="70%" width="70%" alt="Azure Free Account"/> 
</p	
	
> We can now access our Log Analytics platform to review the logs. Please input the following query:	
	
```
// Brute Force Attempt MS SQL Server
let IpAddress_REGEX_PATTERN = @"\b\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}\b";
Event
| where EventLog == "Application"
| where EventID == 18456
| where TimeGenerated > ago(1hr)
| project TimeGenerated, AttackerIP = extract(IpAddress_REGEX_PATTERN, 0, RenderedDescription), DestinationHostName = Computer, RenderedDescription
| summarize FailureCount = count() by AttackerIP, DestinationHostName
| where FailureCount >= 10
```	

> Running this query will produce results that signify a brute force attack on our MS SQL Server. Please be patient as it may take some time for the results to populate, as they rely on the script's execution. Kindly allow sufficient time for the query results to reveal the outcomes of the script execution.
	
<p align="center">
<img src="https://i.imgur.com/L99lx3k.png" height="70%" width="70%" alt="Azure Free Account"/> 
</p

- Following that, we will employ the Malware-Generator-EICAR.ps1 script to simulate the creation of malware on our Windows VM. This step is designed to trigger an incident alert, promptly notifying us of a potential malware attack.

> We can execute this in PowerShell ISE, resulting in the creation of a Windows Security Alert. Alternatively, you have the option to create a .txt file and merge the two sections of the script into it. Saving the file will then trigger the desired alert.

To execute the command in PowerShell ISE, follow these steps:

1. Copy the Malware-Generator-EICAR.ps1 script from our attack scripts folder.
2. Paste the script into a new script file.
3. Modify the parameter for the total number of viruses to generate. Change it to 10.
4. Save the modified script.
5. Finally, run the script to initiate the generation of 10 viruses.

> The script conveniently automates the process for us, but we also have the option to manually perform these steps individually.

<p align="center">
<img src="https://i.imgur.com/nlzsZsj.png" height="70%" width="70%" alt="Azure Free Account"/> 
</p

- To manually initiate the generation of malware, follow these steps:

1. Open a new Notepad document.
2. Copy and paste the first and second half of the script side by side into the Notepad document.
3. Save the file as "EICAR" to the desktop or any desired location.

<p align="center">
<img src="https://i.imgur.com/JDwprcz.png" height="70%" width="70%" alt="Azure Free Account"/> 
</p

- It appears that we have received an alert from Windows Security indicating the necessity to configure ransomware protection.

<p align="center">
<img src="https://i.imgur.com/BNQtVOg.png" height="70%" width="70%" alt="Azure Free Account"/> 
</p

- We should observe the generated malware in both Defender for Cloud and Sentinel. In Sentinel, the detection will only appear if Windows Security has taken action, depending on the configured settings. If the malware is quarantined, you will need to manually take action to resolve it. Following that, please allow some time (which could be quite lengthy) and wait for the incident or use a KQL query to view the details of the incident.

<p align="center">
<img src="https://i.imgur.com/zo2Tu7K.png" height="70%" width="70%" alt="Azure Free Account"/> 
</p

- Subsequently, we will manually access the Azure portal to read the key vault secret named "Tenant-Global-Admin-Password." This action simulates a potential privilege escalation attack. Merely viewing the secret within the key vault should trigger an alert and generate an incident in Sentinel.

> To accomplish this, navigate to the Azure portal. Proceed to the Key Vault section and access the Secrets tab. Locate and select the "Tenant-Global-Admin-Password" secret. Choose the current version and then click on "Show Secret Value" to reveal the contents.

<p align="center">
<img src="https://i.imgur.com/I7YFZwc.png" height="70%" width="70%" alt="Azure Free Account"/> 
</p

- After an adequate amount of time has elapsed, we can proceed to the Log Analytics Workspace to examine the logs and identify any alerts that have been generated. Once our query starts returning results indicating a potential privilege escalation attack, we should anticipate the creation of an incident in Sentinel.

<p align="center">
<img src="https://i.imgur.com/TMGhth9.png" height="70%" width="70%" alt="Azure Free Account"/> 
</p

- We will now simulate an attack by manually toggling the Windows VM firewall, enabling and disabling it, and closely monitoring the resulting incidents.

> To proceed, we will first log into our Windows VM. Then, we will navigate to the Windows machine firewall by searching for "wf.msc". Once there, we will access the "Windows Defender Firewall Properties" and carefully review each tab, including the Domain Profile, Private Profile, and Public Profile. For each profile, we will enable the Firewall state and subsequently disable it to simulate the manipulation of firewall settings.

<p align="center">
<img src="https://i.imgur.com/et1fSTW.png" height="70%" width="70%" alt="Azure Free Account"/> 
</p

- As is customary, kindly allow some time for the logs to populate in the Log Analytics Workspace. Once the logs start appearing, we can anticipate the subsequent creation of an incident in Sentinel, triggered by the simulated attack involving host firewall tampering.
<p align="center">
<img src="https://i.imgur.com/9mJMNxB.png" height="70%" width="70%" alt="Azure Free Account"/> 
</p

<details close>

<details>
  <summary>Details</summary>

### Run Insecure Environment for 24 Hours and Capture Analytics

### Dataset 

Before 24 Hours: 
<div>

| Metric                   | Count
| ------------------------ | -----
| SecurityEvent            | 23146
| Syslog                   | 2123
| SecurityAlert            | 10
| SecurityIncident         | 267
| NSG Inbound Malicious Flows Allowed | 865

![Windows RDP   SMB Authentication Failure(Before)](https://user-images.githubusercontent.com/109401839/235335964-ef063912-f0b7-4761-a95b-911c21f240b7.png)

![Linux SSH Auth Failure (Before)](https://user-images.githubusercontent.com/109401839/235335965-63e57ce1-2d54-4256-a86c-4e7962eda71e.png)

![MySQL Authentication Failures(Before)](https://user-images.githubusercontent.com/109401839/235335966-25b63a64-750c-4275-9f54-a5ec72bd0a7c.png)

![nsg-malicious-allowed-in (before)](https://user-images.githubusercontent.com/109401839/235335967-faab4541-ea6c-4276-8b17-1b446613ff9f.png)

HELPER QUERIES	
		
	Helper KQL Queries
		
Start Time	

``` 
"range x from 1 to 1 step 1
| project StartTime = ago(24h), StopTime = now()"
 ``` 
	
![vivaldi_TqMaMGLc0s](https://user-images.githubusercontent.com/109401839/235334642-729e7798-48b3-43ea-870b-85ed6425f3c1.png)
	
Stop Time			
Security Events (Windows VMs)	"SecurityEvent
| where TimeGenerated >= ago(24h)
| count"

		
Syslog (Linux VMs)	"Syslog
| where TimeGenerated >= ago(24h)
| count"	

	
SecurityAlert (Microsoft Defender for Cloud)	"SecurityAlert
| where DisplayName !startswith ""CUSTOM"" and DisplayName !startswith ""TEST""
| where TimeGenerated >= ago(24h)
| count"
		
Security Incident (Sentinel Incidents)	"SecurityIncident
| where TimeGenerated >= ago(24h)
| count"	

	
NSG Inbound Malicious Flows Allowed	"AzureNetworkAnalytics_CL 
| where FlowType_s == ""MaliciousFlow"" and AllowedInFlows_d > 0
| where TimeGenerated >= ago(24h)
| count"

	
NSG Inbound Malicious Flows Blocked	"AzureNetworkAnalytics_CL 
| where FlowType_s == ""MaliciousFlow"" and DeniedInFlows_d > 0
| where TimeGenerated >= ago(24h)
| count"		

![image](https://user-images.githubusercontent.com/109401839/235336299-df51515e-aea1-424d-a880-572722e5627b.png)

### Incident Response & System Hardening

<div>

</summary>

- We will now proceed with the incidents being generated in Azure Sentinel, following the NIST 800-61 Incident Management Lifecycle. Please utilize the provided [Playbook](https://docs.google.com/document/d/1EQ5MzN95POLaRIMulYg3PIH3UGHtDNcGdkFvgOXyEXQ/edit). As you handle each incident, it is advisable to take notes after completing each step for documentation purposes.

- Step 1: Preparation
(We have already completed this step by ingesting all logs into the Log Analytics Workspace and Sentinel, as well as configuring alert rules.)

- Step 2: Detection & Analysis (You may have different alerts/incidents)

1. Set Severity, Status, and Owner for the incident.
2. View Full Details using the New Experience interface.
3. Review the Activity Log to understand the incident's history.
4. Analyze Entities and Incident Timelines to check for any additional suspicious activities.
5. "Investigate" the incident to determine its scope.
6. Inspect the entities involved and search for related events.
7. Evaluate the legitimacy of the incident (True Positive, False Positive, etc.).
8. If it is a True Positive, continue with the next steps. If it is a False Positive, close the incident.

- Step 3: Containment, Eradication, and Recovery
Follow the steps outlined in the simple Incident Response PlayBook to contain, eradicate, and recover from the incident.

- Step 4: Document Findings/Information and Close the Incident in Sentinel.

<details close>

<div>

</summary>

Incident 1 - Brute Force Success (Windows) - Working Incidents and Incident Response

- We will initiate the response to the Brute Force Success incident on our Windows VM by first establishing the severity level, updating the status, and assigning an owner.

<p align="center">
<img src="https://i.imgur.com/Tn8sOsl.png" height="70%" width="70%" alt="Azure Free Account"/> 
</p

- Next, we will proceed to examine the full details of the incident. Please navigate to the incident details using the new experience interface.

<p align="center">
<img src="https://i.imgur.com/JmZedRE.png" height="70%" width="70%" alt="Azure Free Account"/> 
</p

- Now, let us proceed with observing the Activity Log to review the incident's history and gain a comprehensive understanding of the events that have occurred.

<p align="center">
<img src="https://i.imgur.com/SOD2sXl.png" height="70%" width="70%" alt="Azure Free Account"/> 
</p

- Next, we will shift our attention to observing the Entities and Incident Timelines. This will allow us to determine if the entities involved in the incident are associated with any other attacks or suspicious activities.

<p align="center">
<img src="https://i.imgur.com/CGVqNXT.png" height="70%" width="70%" alt="Azure Free Account"/> 
</p

- By clicking on the IP Address, we can access the corresponding Geo Data and gain insights into the geographic location associated with the IP. 

<p align="center">
<img src="https://i.imgur.com/yGe40wf.png" height="70%" width="70%" alt="Azure Free Account"/> 
</p

- Proceed with the investigation of the incident, persistently working to determine its scope and extent.

<p align="center">
<img src="https://i.imgur.com/l9aNh87.png" height="70%" width="70%" alt="Azure Free Account"/> 
</p

-In case we come across related alerts associated with this attacker, we can explore the correlation between their IP address and other activities. It appears that they are connected to 80 other events, and further investigation into these events may provide valuable insights. 

-This attacker is associated with 6 attempted Brute Force Attacks and has successfully executed over 13 Brute Force Attacks.

 <p align="center">
<img src="https://i.imgur.com/NulWczg.png" height="70%" width="70%" alt="Azure Free Account"/> 
</p>
<p align="center">
<img src="https://i.imgur.com/64nxWCr.png" height="70%" width="70%" alt="Azure Free Account"/> 
</p>

- To access more data, navigate to the "All Aggregated Nodes" view in KQL (Kusto Query Language). This will provide a broader perspective and enable you to explore additional information and insights.

<p align="center">
<img src="https://i.imgur.com/DQJIVZa.png" height="70%" width="70%" alt="Azure Free Account"/> 
</p>
	
- This information can be viewed and analyzed using KQL (Kusto Query Language). 

```
let GetIPRelatedAlerts = (v_IP_Address: string) {
    SecurityAlert
    | summarize arg_max(TimeGenerated, *) by SystemAlertId
    | extend entities = todynamic(Entities)
    | mv-expand entities
    | project-rename entity=entities
    | where entity['Type'] == 'ip' and entity['Address'] =~ v_IP_Address
    | project-away entity
};
GetIPRelatedAlerts(@'174.65.157.233')
```

- Additionally, we can observe that our "windows-vm" appears to be a likely compromised system, given its involvement in an additional 230 incidents/alerts. This indicates a significant level of suspicious activity and raises concerns about the compromised state of the system.

<p align="center">
<img src="https://i.imgur.com/U87NFAb.png" height="70%" width="70%" alt="Azure Free Account"/> 
</p>

- Now, it is crucial to determine the legitimacy of the incident, classifying it as either a True Positive (genuine security issue) or a False Positive (a benign or erroneous event). Assessing the incident's validity will help guide further actions and response strategies.

- To aid in determining the legitimacy of the incident, we can utilize the analytics rule to delve deeper into the attacker's activities. By doing so, we can gather more comprehensive insights into their actions, thereby enabling us to uncover additional information and potentially identify any other nefarious activities they may be involved in.

```
// Brute Force Success Windows
let FailedLogons = SecurityEvent
| where EventID == 4625 and LogonType == 3
| where TimeGenerated > ago(60m)
| summarize FailureCount = count() by AttackerIP = IpAddress, EventID, Activity, LogonType, DestinationHostName = Computer
| where FailureCount >= 5;
let SuccessfulLogons = SecurityEvent
| where EventID == 4624 and LogonType == 3
| where TimeGenerated > ago(60m)
| summarize SuccessfulCount = count() by AttackerIP = IpAddress, LogonType, DestinationHostName = Computer, AuthenticationSuccessTime = TimeGenerated;
SuccessfulLogons
| join kind = leftouter FailedLogons on DestinationHostName, AttackerIP, LogonType
| project AuthenticationSuccessTime, AttackerIP, DestinationHostName, FailureCount, SuccessfulCount
```
Via [Cheat Sheet](https://github.com/joshmadakor1/Cyber-Course/blob/main/KQL-Query-Cheat-Sheet.md) 

- To refine our analysis, we will add a clause to identify entities that have had successful logins within the last 24 hours or within any desired timeframe. This will enable us to focus on the entities that have experienced recent successful login activities and help us uncover any potential security threats associated with them.

```
SecurityEvent
| where EventID == 4624
| distinct Account
``` 

<p align="center">
<img src="https://i.imgur.com/Bk0XpLZ.png" height="70%" width="70%" alt="Azure Free Account"/> 
</p>

- To further refine our analysis, we can narrow down our focus by utilizing the IP address of the attacker. This will allow us to gather more specific and targeted information about the activities associated with that particular IP address, aiding us in better understanding the nature and extent of the attack.

```
| where ipaddress == "174.65.157.233"
```

and remove: 

``` | distinct Account ```

<p align="center">
<img src="https://i.imgur.com/g9IXS5d.png" height="70%" width="70%" alt="Azure Free Account"/> 
</p>

- Based on the findings, I have reached the conclusion that this incident is a False Positive. Allow me to explain why. Despite the recorded "successful" attempts, further analysis reveals that the attacker persisted in their brute force attempts without achieving any actual successful login. Upon inspecting the action from the identified IP address, it becomes apparent that the main concern lies in the persistent nature of this threat actor. Given enough time, they could potentially breach the system.

- In accordance with the incident management process, we would typically proceed if the incident were a true positive. However, since it is a false positive in this case, we will close it out. Nonetheless, it is crucial to acknowledge that the network security posture is inadequate. As a result, we will address this issue by prioritizing the hardening of our systems to significantly reduce the likelihood of such incidents in the future. 

<p align="center">
<img src="https://i.imgur.com/uqAAOQ5.png" height="70%" width="70%" alt="Azure Free Account"/> 
</p>

- Next, we will move on to the phase of Containment, Eradication, and Recovery. To guide us through this process, let's refer to the Incident Response Playbook. This playbook outlines the recommended steps and actions to be taken to contain the incident, eliminate any threats, and restore the affected systems to a secure state. Following the playbook will help ensure an effective and coordinated response to the incident.

### Incident Description
<div>
This incident involves observation of potential brute force attempts against a Windows VM.

### Initial Response Actions
<div>

- Verify the authenticity of the alert or report

- Immediately isolate the machine and change the password of the affected user.

- Identify the origin of the attacks and determine if they are attacking or involved with anything else.

- Determine how and when the attack occurred
Are the NSGs not being locked down? If so, check other NSGs

- Assess the potential impact of the incident.

- What type of account was it? Permissions?

### Containment and Recovery
<div>

- Lock down the NSG assigned to that VM/Subnet, either entirely, or to allow only necessary traffic

- Reset the affected user’s password

- Enable MFA

### Document Findings and Close out Incident

<p align="center">
<img src="https://i.imgur.com/3OUfoDF.png" height="70%" width="70%" alt="Azure Free Account"/> 
</p>

- As part of the containment measures, we will restrict access to the VM by allowing only our specified IP address to connect. This can be achieved by configuring the firewall rules to permit incoming connections exclusively from our IP address and specifying the subnet mask as /32, which restricts access to only that specific IP address. By implementing this restriction, we can minimize the risk of unauthorized access to the VM and strengthen its security.

<p align="center">
<img src="https://i.imgur.com/4on9DG9.png" height="70%" width="70%" alt="Azure Free Account"/> 
</p>

- To bolster security measures across all our VMs, we will proceed with removing the unrestricted RDP (Remote Desktop Protocol) rule that was previously configured. This deliberate action is essential in eliminating any potential vulnerabilities that could be exploited through brute force attacks targeting the RDP service. By uniformly removing this rule from all our VMs, we significantly reduce the attack surface and reinforce the overall security posture of our systems. This proactive approach is crucial for mitigating the risk of unauthorized access and ensuring a robust defense against potential threats.

### Incident 2 - Possible Privilege Escalation - Working Incidents and Incident Response
<details close>

<div>

</summary>

- Next, we will repeat the same process for the next incident, which involves a suspected privilege escalation attack. This incident requires our attention to follow the established incident management lifecycle and execute the necessary steps to contain, eradicate, and recover from the potential threat. By applying the Incident Response Playbook and leveraging our knowledge and experience, we can effectively address this incident and mitigate any potential risks associated with privilege escalation. Let's proceed with the necessary actions to ensure the security and integrity of our systems.

<p align="center">
<img src="https://i.imgur.com/BeuXzfD.png" height="70%" width="70%" alt="Azure Free Account"/> 
</p>

- This incident has been associated with a total of 120 events and triggered 30 alerts.

- Based on our investigation, we have determined that the incident was caused by the PowerShell script that I had left running on my virtual machine. Considering the matching IP address, we can conclude that this is a false positive. However, it is crucial to note that if this were a genuine incident, we would need to investigate the source generating such a high number of alerts. Such a scenario warrants thorough analysis to identify the underlying cause and ensure that any potential security risks are addressed promptly. While we can dismiss this particular incident as a false positive, it emphasizes the importance of investigating and addressing any real incidents that generate a significant number of alerts.

<p align="center">
<img src="https://i.imgur.com/m7Qbc12.png" height="70%" width="70%" alt="Azure Free Account"/> 
</p>

- Since this incident occurred within our organization, it would be prudent to directly reach out to the user involved and confirm the details with them. In this scenario, let's assume that the user was simply performing their normal duties as a pentester and had obtained proper authorization from their manager to conduct the activities in question. By contacting the user and corroborating the incident details, we can validate that it was an authorized and expected activity. Consequently, we can confidently classify this incident as a false positive, resulting from inaccurate data or misinterpretation of the situation. We will proceed to close the incident, ensuring that it is properly documented for future reference and analysis.

<p align="center">
<img src="https://i.imgur.com/5l1TvXA.png" height="70%" width="70%" alt="Azure Free Account"/> 
</p>

- Up to this point, I have successfully closed three incidents: one related to a brute force attack, another involving permission escalation, and a duplicate incident that was identical to the initial brute force attack. By following the incident management process, including thorough investigation, analysis, and validation, I was able to determine the appropriate resolution for each incident. Closing these incidents signifies that the necessary actions have been taken to address the identified security concerns, ensuring the protection and integrity of our systems.

![vivaldi_MjJTET0DBT](https://user-images.githubusercontent.com/109401839/235338870-1c478632-83f8-4777-b593-cb21196276b6.png)

<details close>

<div>

</summary>

### Incident 3 - Brute Force Success (Linux) - Microsoft Sentinel Working Incidents and Incident Response

- During my lab testing, I did not observe any successful Linux brute force attacks by individuals other than myself, which was intentionally conducted for demonstration purposes. However, there were numerous attempts made to breach the system by simulated attackers. These attempts highlight the importance of implementing robust security measures to protect against potential unauthorized access and reinforce the need for proactive security practices within our Linux environment. 

<p align="center">
<img src="https://i.imgur.com/ebaCZpY.png" height="70%" width="70%" alt="Azure Free Account"/> 
</p>

<p align="center">
<img src="https://i.imgur.com/uIXj9yu.png" height="70%" width="70%" alt="Azure Free Account"/> 
</p>
	
- To perform thorough due diligence and confirm if any successful brute force attacks occurred, we can utilize the following KQL query:

<p align="center">
<img src="https://i.imgur.com/RllNw5K.png" height="70%" width="70%" alt="Azure Free Account"/> 
</p>

- To summarize, we can close this incident as a Benign-True Positive since there were no successful brute force attacks detected. However, to gather more detailed information, we can customize the query by examining each IP address individually. This level of granularity is useful when dealing with a larger-scale scenario, such as when thousands of IP addresses within an organization are attempting brute force attacks, and we want to focus on a specific IP address.

- Additionally, as a proactive measure, we can reset the passwords associated with the affected accounts. By doing so, we further mitigate the risk of unauthorized access and ensure the security of our systems.

<p align="center">
<img src="https://i.imgur.com/fOBm9AH.png" height="70%" width="70%" alt="Azure Free Account"/> 
</p>

- To summarize, following the playbook, we investigated if the incident was related to any other events. It was discovered that the compromised user virtual machine and the associated network security group (NSG) were indeed involved in other incidents. To remediate the situation, we took immediate action by resetting the password of the compromised user virtual machine and implementing tighter restrictions on the NSG.

- Based on these actions and the absence of further malicious activities, we can confidently close this incident as a Benign-True Positive. The necessary steps have been taken to mitigate the risk and ensure the security of our systems. Incident closed.

- Considering the impact of the incident, it was observed that the compromised account belonged to a non-administrative user on a Linux virtual machine. This indicates a potentially low impact. However, it is important to note that the attacker is involved in numerous other incidents, which raises concerns about the overall security posture.

- To address this, we will focus on remediating the situation by implementing NSG hardening measures. By strengthening the network security group configurations, we aim to prevent any further unauthorized access attempts and mitigate the risk posed by the attacker.

- By taking these steps, we are proactively addressing the incident and working towards enhancing the security of our systems.

<details close>

<div>

</summary>

### Incident 4 - Possible Malware Outbreak - Working Incidents and Incident Response

![vivaldi_cmkHl8ibDk](https://user-images.githubusercontent.com/109401839/235339661-ed54b589-0d13-440e-9f8d-d1901c8076dd.png)

![vivaldi_iK4n16GqXA](https://user-images.githubusercontent.com/109401839/235339714-28549a49-b758-40a7-badf-cb90fcd73602.png)

![vivaldi_2ggFSrbzOX](https://user-images.githubusercontent.com/109401839/235339755-a413874f-da99-4781-a076-3cc49bb7a7d8.png)

Here do not know if the extended alerts are actually related to the incident. In thsi case malware, but it can be as typically with a breach, threat actors drop malware in as well. 

> Note: Several other alerts raised. 

We can examine the query that generated this alert. 

![vivaldi_ulG9cGZsXz](https://user-images.githubusercontent.com/109401839/235339859-2eb3d7c1-55a5-4a16-b396-1f1a0d405e3e.png)

This can be filtered by comprised entity category in KQL. 

![vivaldi_7ytY4TuYHb](https://user-images.githubusercontent.com/109401839/235339840-376912f2-8e7f-4cf3-a4ee-8bd6ba4fb9a7.png)

We can add another query to see if there is no action necessary and if the malware was remediated. 

![vivaldi_7aC88zFKiR](https://user-images.githubusercontent.com/109401839/235339918-c3fdaba0-4dc6-427a-a342-dd469a384561.png)

Which looks like it was automatically remidiated. 

We can do our due diligence and make sure by viewing the the file path. 

![vivaldi_8tIZy1xL5Q](https://user-images.githubusercontent.com/109401839/235339965-2fd9de11-2b8e-4011-8a8b-47ccd9708971.png)

It is benign true positive. 

![vivaldi_EPWAjpIU5D](https://user-images.githubusercontent.com/109401839/235340033-f65d3618-a31a-4d8f-810a-3bf5f076cffc.png)

That is it for the SIEM labs, I will mass close the tickets as Benign Positive - Suspicious but expected. 

![vivaldi_pL3PCdQkUO](https://user-images.githubusercontent.com/109401839/235340122-ae0340b3-58bb-482b-9871-0afb6e7cc5af.png)

Next part, we will harden the environment after 24 hours and document it. 

Now lets wait 24 hours. 

![vivaldi_Vbe3M5A01o](https://user-images.githubusercontent.com/109401839/235340150-0b193cd6-dbb7-4c01-b256-e5fc26c0e267.png)
